/*
 * SPDX-License-Identifier: MIT OR Apache-2.0
 * Copyright (c) 2026 gwz
 */

module driver_test;

import std.io;
import std.string;
import std.assert;

import source_paths;
import driver;

func fixture_root() -> string {
    return "compiler/stage2_l0/tests/fixtures/driver";
}

func make_paths() -> SourceSearchPaths* {
    let sp = sp_create();
    sp_add_project_root(sp, fixture_root());
    return sp;
}

func has_driver_diag_code(result: DriverState*, code: string) -> bool {
    for (let i = 0; i < driver_diag_count(result); i = i + 1) {
        let d = driver_diag_get(result, i);
        if (eq_s(d.code, code)) {
            return true;
        }
    }
    return false;
}

func test_transitive_import_closure_ok() {
    let sp = make_paths();
    let result = driver_analyze_entry(sp, "ok_main");

    assert(!driver_has_errors(result), "expected no driver errors for ok_main");
    assert(driver_unit_count(result) == 4, "expected 4 loaded modules in closure");

    driver_state_free(result);
    sp_free(sp);
}

func test_import_cycle_reports_error() {
    let sp = make_paths();
    let result = driver_analyze_entry(sp, "cycle_a");

    assert(driver_has_errors(result), "expected cycle errors");
    assert(has_driver_diag_code(result, "DRV-0030"), "expected DRV-0030 for cycle");

    driver_state_free(result);
    sp_free(sp);
}

func test_module_name_mismatch_reports_error() {
    let sp = make_paths();
    let result = driver_analyze_entry(sp, "mismatch");

    assert(driver_has_errors(result), "expected mismatch errors");
    assert(has_driver_diag_code(result, "DRV-0020"), "expected DRV-0020 for module mismatch");

    driver_state_free(result);
    sp_free(sp);
}

func test_read_failure_reports_error() {
    let sp = make_paths();
    let result = driver_analyze_entry(sp, "read_fail");

    assert(driver_has_errors(result), "expected read failure errors");
    assert(has_driver_diag_code(result, "DRV-0011"), "expected DRV-0011 for read failure");

    driver_state_free(result);
    sp_free(sp);
}

func main() {
    test_transitive_import_closure_ok();
    test_import_cycle_reports_error();
    test_module_name_mismatch_reports_error();
    test_read_failure_reports_error();
    printl_s("driver_test: all tests passed");
}
