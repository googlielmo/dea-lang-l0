/*
 * SPDX-License-Identifier: MIT OR Apache-2.0
 * Copyright (c) 2025-2026 gwz
 */

module util_text_test;

import std.io;
import std.string;
import std.unit;
import std.assert;

import util.text;

func print_bool(label: string, val: bool) {
    if (val) {
        printl_ss(label, "true");
    } else {
        printl_ss(label, "false");
    }
}

func test_is_space() {
    printl_s("=== Test is_space ===");

    print_bool("  is_space(' '):", is_space(' '));
    print_bool("  is_space('\\t'):", is_space('\t'));
    print_bool("  is_space('\\n'):", is_space('\n'));
    print_bool("  is_space('\\r'):", is_space('\r'));
    print_bool("  is_space('a'):", is_space('a'));
    print_bool("  is_space('0'):", is_space('0'));
    print_bool("  is_space('!'):", is_space('!'));

    assert(is_space(' '), "Expected is_space(' ') to be true");
    assert(is_space('\t'), "Expected is_space('\\t') to be true");
    assert(is_space('\n'), "Expected is_space('\\n') to be true");
    assert(!is_space('a'), "Expected is_space('a') to be false");
    assert(!is_space('0'), "Expected is_space('0') to be false");
    assert(!is_space('!'), "Expected is_space('!') to be false");

    printl_s("is_space tests passed!\n");
}

func test_is_digit() {
    printl_s("=== Test is_digit ===");

    print_bool("  is_digit('0'):", is_digit('0'));
    print_bool("  is_digit('5'):", is_digit('5'));
    print_bool("  is_digit('9'):", is_digit('9'));
    print_bool("  is_digit('a'):", is_digit('a'));
    print_bool("  is_digit('Z'):", is_digit('Z'));
    print_bool("  is_digit(' '):", is_digit(' '));

    printl_s("is_digit tests passed!\n");
}

func test_is_alpha() {
    printl_s("=== Test is_alpha ===");

    print_bool("  is_alpha('a'):", is_alpha('a'));
    print_bool("  is_alpha('z'):", is_alpha('z'));
    print_bool("  is_alpha('A'):", is_alpha('A'));
    print_bool("  is_alpha('Z'):", is_alpha('Z'));
    print_bool("  is_alpha('m'):", is_alpha('m'));
    print_bool("  is_alpha('0'):", is_alpha('0'));
    print_bool("  is_alpha(' '):", is_alpha(' '));
    print_bool("  is_alpha('_'):", is_alpha('_'));

    assert(is_alpha('a'), "Expected is_alpha('a') to be true");
    assert(is_alpha('z'), "Expected is_alpha('z') to be true");
    assert(is_alpha('A'), "Expected is_alpha('A') to be true");
    assert(is_alpha('Z'), "Expected is_alpha('Z') to be true");
    assert(is_alpha('m'), "Expected is_alpha('m') to be true");
    assert(!is_alpha('0'), "Expected is_alpha('0') to be false");
    assert(!is_alpha(' '), "Expected is_alpha(' ') to be false");
    assert(!is_alpha('_'), "Expected is_alpha('_') to be false");

    printl_s("is_alpha tests passed!\n");
}

func test_is_alnum() {
    printl_s("=== Test is_alnum ===");

    print_bool("  is_alnum('a'):", is_alnum('a'));
    print_bool("  is_alnum('Z'):", is_alnum('Z'));
    print_bool("  is_alnum('5'):", is_alnum('5'));
    print_bool("  is_alnum('_'):", is_alnum('_'));
    print_bool("  is_alnum(' '):", is_alnum(' '));

    assert(is_alnum('a'), "Expected is_alnum('a') to be true");
    assert(is_alnum('Z'), "Expected is_alnum('Z') to be true");
    assert(is_alnum('5'), "Expected is_alnum('5') to be true");
    assert(!is_alnum('_'), "Expected is_alnum('_') to be false");
    assert(!is_alnum(' '), "Expected is_alnum(' ') to be false");

    printl_s("is_alnum tests passed!\n");
}

func test_to_digit() {
    printl_s("=== Test to_digit ===");

    printl_si("  to_digit('0'):", to_digit('0'));
    printl_si("  to_digit('1'):", to_digit('1'));
    printl_si("  to_digit('5'):", to_digit('5'));
    printl_si("  to_digit('9'):", to_digit('9'));

    assert(to_digit('0') == 0, "Expected to_digit('0') to be 0");
    assert(to_digit('1') == 1, "Expected to_digit('1') to be 1");
    assert(to_digit('5') == 5, "Expected to_digit('5') to be 5");
    assert(to_digit('9') == 9, "Expected to_digit('9') to be 9");

    printl_s("to_digit tests passed!\n");
}

func test_to_upper() {
    printl_s("=== Test to_upper ===");

    printl_si("  to_upper('a') (expect 65):", to_upper('a'));
    printl_si("  to_upper('z') (expect 90):", to_upper('z'));
    printl_si("  to_upper('A') (expect 65):", to_upper('A'));
    printl_si("  to_upper('5') (expect 53):", to_upper('5'));

    assert(to_upper('a') == 'A', "Expected to_upper('a') to be 'A'");
    assert(to_upper('z') == 'Z', "Expected to_upper('z') to be 'Z'");
    assert(to_upper('A') == 'A', "Expected to_upper('A') to be 'A'");
    assert(to_upper('5') == '5', "Expected to_upper('5') to be '5'");

    printl_s("to_upper tests passed!\n");
}

func test_to_lower() {
    printl_s("=== Test to_lower ===");

    printl_si("  to_lower('A') (expect 97):", to_lower('A'));
    printl_si("  to_lower('Z') (expect 122):", to_lower('Z'));
    printl_si("  to_lower('a') (expect 97):", to_lower('a'));
    printl_si("  to_lower('5') (expect 53):", to_lower('5'));

    assert(to_lower('A') == 'a', "Expected to_lower('A') to be 'a'");
    assert(to_lower('Z') == 'z', "Expected to_lower('Z') to be 'z'");
    assert(to_lower('a') == 'a', "Expected to_lower('a') to be 'a'");
    assert(to_lower('5') == '5', "Expected to_lower('5') to be '5'");

    printl_s("to_lower tests passed!\n");
}

func test_string_buffer() {
    printl_s("=== Test StringBuffer ===");

    printl_s("Creating StringBuffer...");
    let sb = sb_create();

    printl_s("Appending strings: 'Hello', ', ', 'World', '!'...");
    sb_append(sb, "Hello");
    sb_append(sb, ", ");
    sb_append(sb, "World");
    sb_append(sb, "!");

    printl_si("  sb_size:", sb_size(sb));

    let result = sb_to_string(sb);
    printl_ss("  sb_to_string:", result);

    assert(eq_s(result, "Hello, World!"), "Expected sb_to_string() to be 'Hello, World!'");

    sb_free(sb);
    printl_s("StringBuffer tests passed!\n");
}

func test_string_buffer_empty() {
    printl_s("=== Test StringBuffer (empty) ===");

    let sb = sb_create();
    printl_si("  empty sb_size:", sb_size(sb));
    let result = sb_to_string(sb);
    printl_ss("  empty sb_to_string:", result);
    printl_si("  result length:", len_s(result));

    assert(sb_size(sb) == 0, "Expected empty sb_size() to be 0");
    assert(eq_s(result, ""), "Expected empty sb_to_string() to be ''");

    sb_free(sb);
    printl_s("Empty StringBuffer tests passed!\n");
}

func test_char_buffer() {
    printl_s("=== Test CharBuffer ===");

    printl_s("Creating CharBuffer...");
    let cb = cb_create();

    printl_s("Appending chars: 'H', 'e', 'l', 'l', 'o'...");
    cb_append(cb, 'H');
    cb_append(cb, 'e');
    cb_append(cb, 'l');
    cb_append(cb, 'l');
    cb_append(cb, 'o');

    printl_si("  cb_size:", cb_size(cb));

    let result = cb_to_string(cb);
    printl_ss("  cb_to_string:", result);

    assert(eq_s(result, "Hello"), "Expected cb_to_string() to be 'Hello'");

    cb_free(cb);
    printl_s("CharBuffer tests passed!\n");
}

func test_char_buffer_clear() {
    printl_s("=== Test CharBuffer clear ===");

    let cb = cb_create();
    cb_append(cb, 'A');
    cb_append(cb, 'B');
    cb_append(cb, 'C');
    printl_si("  size before clear:", cb_size(cb));

    printl_s("Clearing buffer...");
    cb_clear(cb);
    printl_si("  size after clear:", cb_size(cb));

    printl_s("Appending 'X', 'Y' after clear...");
    cb_append(cb, 'X');
    cb_append(cb, 'Y');
    printl_si("  size after new appends:", cb_size(cb));

    let result = cb_to_string(cb);
    printl_ss("  cb_to_string:", result);

    assert(eq_s(result, "XY"), "Expected cb_to_string() to be 'XY' after clear and append");

    cb_free(cb);
    printl_s("CharBuffer clear tests passed!\n");
}

func test_concat3_s() {
    printl_s("=== Test concat3_s ===");

    let result = concat3_s("one", "-", "two");
    printl_ss("  concat3_s('one', '-', 'two'):", result);

    let result2 = concat3_s("", "middle", "");
    printl_ss("  concat3_s('', 'middle', ''):", result2);

    let result3 = concat3_s("a", "b", "c");
    printl_ss("  concat3_s('a', 'b', 'c'):", result3);

    assert(eq_s(result, "one-two"), "Expected concat3_s to be 'one-two'");
    assert(eq_s(result2, "middle"), "Expected concat3_s to be 'middle'");
    assert(eq_s(result3, "abc"), "Expected concat3_s to be 'abc'");

    printl_s("concat3_s tests passed!\n");
}

func test_repeat_s() {
    printl_s("=== Test repeat_s ===");

    let r1 = repeat_s("ab", 3);
    printl_ss("  repeat_s('ab', 3):", r1);

    let r2 = repeat_s("x", 5);
    printl_ss("  repeat_s('x', 5):", r2);

    let r3 = repeat_s("hello", 0);
    printl_ss("  repeat_s('hello', 0):", r3);
    printl_si("    (length):", len_s(r3));

    let r4 = repeat_s("!", 1);
    printl_ss("  repeat_s('!', 1):", r4);

    assert(eq_s(r1, "ababab"), "Expected repeat_s('ab', 3) to be 'ababab'");
    assert(eq_s(r2, "xxxxx"), "Expected repeat_s('x', 5) to be 'xxxxx'");
    assert(eq_s(r3, ""), "Expected repeat_s('hello', 0) to be ''");
    assert(eq_s(r4, "!"), "Expected repeat_s('!', 1) to be '!'");

    printl_s("repeat_s tests passed!\n");
}

func test_trim_s() {
    printl_s("=== Test trim_s ===");

    let t1 = trim_s("  hello  ");
    printl_s(concat3_s("  trim_s('  hello  '): '", t1, "'"));

    let t2 = trim_s("no spaces");
    printl_s(concat3_s("  trim_s('no spaces'): '", t2, "'"));

    let t3 = trim_s("   ");
    printl_s(concat3_s("  trim_s('   '): '", t3, "'"));
    printl_si("    (length):", len_s(t3));

    let t4 = trim_s("\t\n  spaced \n\t");
    printl_s(concat3_s("  trim_s('\\t\\n  spaced \\n\\t'): '", t4, "'"));

    let t5 = trim_s("");
    printl_s(concat3_s("  trim_s(''): '", t5, "'"));
    printl_si("    (length):", len_s(t5));

    assert(eq_s(t1, "hello"), "Expected trim_s('  hello  ') to be 'hello'");
    assert(eq_s(t2, "no spaces"), "Expected trim_s('no spaces') to be 'no spaces'");
    assert(eq_s(t3, ""), "Expected trim_s('   ') to be ''");
    assert(eq_s(t4, "spaced"), "Expected trim_s('\\t\\n  spaced \\n\\t') to be 'spaced'");
    assert(eq_s(t5, ""), "Expected trim_s('') to be ''");

    printl_s("trim_s tests passed!\n");
}

func test_to_upper_s() {
    printl_s("=== Test to_upper_s ===");

    let u1 = to_upper_s("hello");
    printl_ss("  to_upper_s('hello'):", u1);

    let u2 = to_upper_s("Hello World");
    printl_ss("  to_upper_s('Hello World'):", u2);

    let u3 = to_upper_s("ALREADY UPPER");
    printl_ss("  to_upper_s('ALREADY UPPER'):", u3);

    let u4 = to_upper_s("123abc");
    printl_ss("  to_upper_s('123abc'):", u4);

    let u5 = to_upper_s("");
    printl_ss("  to_upper_s(''):", u5);
    printl_si("    (length):", len_s(u5));

    assert(eq_s(u1, "HELLO"), "Expected to_upper_s('hello') to be 'HELLO'");
    assert(eq_s(u2, "HELLO WORLD"), "Expected to_upper_s('Hello World') to be 'HELLO WORLD'");
    assert(eq_s(u3, "ALREADY UPPER"), "Expected to_upper_s('ALREADY UPPER') to be 'ALREADY UPPER'");
    assert(eq_s(u4, "123ABC"), "Expected to_upper_s('123abc') to be '123ABC'");
    assert(eq_s(u5, ""), "Expected to_upper_s('') to be ''");

    printl_s("to_upper_s tests passed!\n");
}

func test_to_lower_s() {
    printl_s("=== Test to_lower_s ===");

    let l1 = to_lower_s("HELLO");
    printl_ss("  to_lower_s('HELLO'):", l1);

    let l2 = to_lower_s("Hello World");
    printl_ss("  to_lower_s('Hello World'):", l2);

    let l3 = to_lower_s("already lower");
    printl_ss("  to_lower_s('already lower'):", l3);

    let l4 = to_lower_s("123ABC");
    printl_ss("  to_lower_s('123ABC'):", l4);

    let l5 = to_lower_s("");
    printl_ss("  to_lower_s(''):", l5);
    printl_si("    (length):", len_s(l5));

    assert(eq_s(l1, "hello"), "Expected to_lower_s('HELLO') to be 'hello'");
    assert(eq_s(l2, "hello world"), "Expected to_lower_s('Hello World') to be 'hello world'");
    assert(eq_s(l3, "already lower"), "Expected to_lower_s('already lower') to be 'already lower'");
    assert(eq_s(l4, "123abc"), "Expected to_lower_s('123ABC') to be '123abc'");
    assert(eq_s(l5, ""), "Expected to_lower_s('') to be ''");

    printl_s("to_lower_s tests passed!\n");
}

func test_string_to_int() -> Unit? {
    printl_s("=== Test string_to_int ===");

    let s1 = "12345";
    let v1 = string_to_int(s1)?;
    printl_si(concat3_s("  string_to_int('", s1, "'):"), v1);

    let s2 = "-6789";
    let v2 = string_to_int(s2)?;
    printl_si(concat3_s("  string_to_int('", s2, "'):"), v2);

    let s3 = "0";
    let v3 = string_to_int(s3)?;
    printl_si(concat3_s("  string_to_int('", s3, "'):"), v3);

    // INT_MIN
    let s4 = "-2147483648"; // INT_MIN
    let v4 = string_to_int(s4)?;
    printl_si(concat3_s("  string_to_int('", s4, "'):"), v4);

    // INT_MAX
    let s7 = "2147483647"; // INT_MAX
    let v7 = string_to_int(s7)?;
    printl_si(concat3_s("  string_to_int('", s7, "'):"), v7);

    // check underflow
    let s6 = "-2147483649"; // INT_MIN - 1
    let v6 = string_to_int(s6);
    if (v6 == null) {
        printl_s(concat3_s("  string_to_int('", s6, "'): null (underflow) OK"));
    }

    // check overflow
    let s5 = "2147483648"; // INT_MAX + 1
    let v5 = string_to_int(s5);
    if (v5 == null) {
        printl_s(concat3_s("  string_to_int('", s5, "'): null (overflow) OK"));
    }

    let s8 = "9999999999"; // definitely overflow
    let v8 = string_to_int(s8);
    if (v8 == null) {
        printl_s(concat3_s("  string_to_int('", s8, "'): null (overflow) OK"));
    }

    let s9 = "-9999999999"; // definitely underflow
    let v9 = string_to_int(s9);
    if (v9 == null) {
        printl_s(concat3_s("  string_to_int('", s9, "'): null (underflow) OK"));
    }

    assert(v1 == 12345, "Expected string_to_int('12345') to be 12345");
    assert(v2 == -6789, "Expected string_to_int('-6789') to be -6789");
    assert(v3 == 0, "Expected string_to_int('0') to be 0");
    assert(v4 == -2147483648, "Expected string_to_int('-2147483648') to be -2147483648");
    assert(v7 == 2147483647, "Expected string_to_int('2147483647') to be 2147483647");
    assert(v6 == null, "Expected string_to_int('-2147483649') to be null (underflow)");
    assert(v5 == null, "Expected string_to_int('2147483648') to be null (overflow)");
    assert(v8 == null, "Expected string_to_int('9999999999') to be null (overflow)");
    assert(v9 == null, "Expected string_to_int('-9999999999') to be null (underflow)");

    printl_s("string_to_int tests passed!\n");

    return std.unit::present();
}

func test_int_to_string() {
    printl_s("=== Test int_to_string ===");

    let i1 = 12345;
    let s1 = int_to_string(i1);
    print_si("  int_to_string(", i1);
    printl_ss("):", int_to_string(i1));

    let i2 = -6789;
    let s2 = int_to_string(i2);
    print_si("  int_to_string(", i2);
    printl_ss("):", int_to_string(i2));

    let i3 = 0;
    let s3 = int_to_string(i3);
    print_si("  int_to_string(", i3);
    printl_ss("):", int_to_string(i3));

    let i4 = -2147483648; // INT_MIN
    let s4 = int_to_string(i4);
    print_si("  int_to_string(", i4);
    printl_ss("):", int_to_string(i4));

    let i5 = 2147483647; // INT_MAX
    let s5 = int_to_string(i5);
    print_si("  int_to_string(", i5);
    printl_ss("):", int_to_string(i5));

    assert(eq_s(s1, "12345"), "Expected int_to_string(12345) to be '12345'");
    assert(eq_s(s2, "-6789"), "Expected int_to_string(-6789) to be '-6789'");
    assert(eq_s(s3, "0"), "Expected int_to_string(0) to be '0'");
    assert(eq_s(s4, "-2147483648"), "Expected int_to_string(-2147483648) to be '-2147483648'");
    assert(eq_s(s5, "2147483647"), "Expected int_to_string(2147483647) to be '2147483647'");

    printl_s("int_to_string tests passed!\n");
}

// test int_to_hex_string
func test_int_to_hex_string() {
    printl_s("=== Test int_to_hex_string ===");

    let i1 = 255;
    let s1 = int_to_hex_string(i1);
    print_si("  int_to_hex_string(", i1);
    printl_ss("):", s1);

    let i2 = 4095;
    let s2 = int_to_hex_string(i2);
    print_si("  int_to_hex_string(", i2);
    printl_ss("):", s2);

    let i3 = 0;
    let s3 = int_to_hex_string(i3);
    print_si("  int_to_hex_string(", i3);
    printl_ss("):", s3);

    let i4 = 305419896; // 0x12345678
    let s4 = int_to_hex_string(i4);
    print_si("  int_to_hex_string(", i4);
    printl_ss("):", s4);

    let i5 = -1; // negative number
    let s5 = int_to_hex_string(i5);
    print_si("  int_to_hex_string(", i5);
    printl_ss("):", s5);

    let i6 = -2147483648; // INT_MIN
    let s6 = int_to_hex_string(i6);
    print_si("  int_to_hex_string(", i6);
    printl_ss("):", s6);

    assert(eq_s(s1, "ff"), "Expected int_to_hex_string(255) to be 'ff'");
    assert(eq_s(s2, "fff"), "Expected int_to_hex_string(4095) to be 'fff'");
    assert(eq_s(s3, "0"), "Expected int_to_hex_string(0) to be '0'");
    assert(eq_s(s4, "12345678"), "Expected int_to_hex_string(305419896) to be '12345678'");
    assert(eq_s(s5, "-1"), "Expected int_to_hex_string(-1) to be '-1'");
    assert(eq_s(s6, "-80000000"), "Expected int_to_hex_string(-2147483648) to be '-80000000'");

    printl_s("int_to_hex_string tests passed!\n");
}

func test_int_to_bin_string() {
    printl_s("=== Test int_to_bin_string ===");

    let i1 = 5;
    let s1 = int_to_bin_string(i1);
    print_si("  int_to_bin_string(", i1);
    printl_ss("):", s1);

    let i2 = 10;
    let s2 = int_to_bin_string(i2);
    print_si("  int_to_bin_string(", i2);
    printl_ss("):", s2);

    let i3 = 0;
    let s3 = int_to_bin_string(i3);
    print_si("  int_to_bin_string(", i3);
    printl_ss("):", s3);

    let i4 = -1; // negative number
    let s4 = int_to_bin_string(i4);
    print_si("  int_to_bin_string(", i4);
    printl_ss("):", s4);

    let i5 = -2147483648; // INT_MIN
    let s5 = int_to_bin_string(i5);
    print_si("  int_to_bin_string(", i5);
    printl_ss("):", s5);

    assert(eq_s(s1, "101"), "Expected int_to_bin_string(5) to be '101'");
    assert(eq_s(s2, "1010"), "Expected int_to_bin_string(10) to be '1010'");
    assert(eq_s(s3, "0"), "Expected int_to_bin_string(0) to be '0'");
    assert(eq_s(s4, "-1"), "Expected int_to_bin_string(-1) to be '-1'");
    assert(eq_s(s5, "-10000000000000000000000000000000"), "Expected int_to_bin_string(-2147483648) to be '-10000000000000000000000000000000'");

    printl_s("int_to_bin_string tests passed!\n");
}

func main() -> int {
    printl_s("==========================================");
    printl_s("      String Utilities Test Suite");
    printl_s("==========================================\n");

    // Character classification
    test_is_space();
    test_is_digit();
    test_is_alpha();
    test_is_alnum();

    // Character manipulation
    test_to_digit();
    test_to_upper();
    test_to_lower();

    // StringBuffer
    test_string_buffer();
    test_string_buffer_empty();

    // CharBuffer
    test_char_buffer();
    test_char_buffer_clear();

    // String utilities
    test_concat3_s();
    test_repeat_s();
    test_trim_s();
    test_to_upper_s();
    test_to_lower_s();

    // String <-> int conversions
    test_string_to_int();
    test_int_to_string();
    test_int_to_bin_string();
    test_int_to_hex_string();

    printl_s("==========================================");
    printl_s("  All String Utility tests passed!");
    printl_s("==========================================");

    return 0;
}
